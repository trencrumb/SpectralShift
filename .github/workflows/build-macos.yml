name: Build macOS

on:
  workflow_dispatch:
  #push:
  #  branches: [ main ]
  #pull_request:

concurrency:
  group: ${{ github.ref }}-macos
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  BUILD_DIR: Builds
  HOMEBREW_NO_INSTALL_CLEANUP: 1

defaults:
  run:
    shell: bash

jobs:
  build_macos:
    name: macOS
    runs-on: macos-14

    steps:
      - name: Install macOS Deps
        run: brew install ninja osxutils

      - name: Use latest Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache the build (sccache)
        uses: mozilla-actions/sccache-action@v0.0.9
        env:
          SCCACHE_GHA_ENABLED: true

      - name: Configure
        run: cmake -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache -G Ninja -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"

      - name: Build
        run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

      - name: Read in .env from CMake
        run: |
          cat ${{ env.BUILD_DIR }}/.env
          cat ${{ env.BUILD_DIR }}/.env >> $GITHUB_ENV

      - name: Set additional env vars for artifacts
        run: |
          ARTIFACTS_PATH="${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}_artefacts/${{ env.BUILD_TYPE }}"
          echo "ARTIFACTS_PATH=$ARTIFACTS_PATH" >> $GITHUB_ENV
          echo "VST3_PATH=$ARTIFACTS_PATH/VST3/${{ env.PRODUCT_NAME }}.vst3" >> $GITHUB_ENV
          echo "AU_PATH=$ARTIFACTS_PATH/AU/${{ env.PRODUCT_NAME }}.component" >> $GITHUB_ENV
          echo "CLAP_PATH=$ARTIFACTS_PATH/CLAP/${{ env.PRODUCT_NAME }}.clap" >> $GITHUB_ENV
          echo "STANDALONE_PATH=$ARTIFACTS_PATH/Standalone/${{ env.PRODUCT_NAME }}.app" >> $GITHUB_ENV
          echo "LV2_PATH=$ARTIFACTS_PATH/LV2/${{ env.PRODUCT_NAME }}.lv2" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${{ env.PRODUCT_NAME }}-${{ env.VERSION }}-macOS" >> $GITHUB_ENV

      - name: Pluginval (before signing)
        run: |
          curl -LO "https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_macOS.zip"
          7z x pluginval_macOS.zip
          pluginval.app/Contents/MacOS/pluginval --strictness-level 10 --verbose \
            --validate "${{ env.VST3_PATH }}"

      - name: Import Developer ID Certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.DEV_ID_CERT }}
          p12-password: ${{ secrets.DEV_ID_CERT_PASSWORD }}

      - name: Code Sign VST3
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.VST3_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.VST3_PATH }}"

      - name: Code Sign AU
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.AU_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.AU_PATH }}"

      - name: Code Sign Standalone
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.STANDALONE_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.STANDALONE_PATH }}"

      - name: Code Sign CLAP
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.CLAP_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.CLAP_PATH }}"

      - name: Code Sign LV2
        run: |
          # LV2 is not a macOS bundle, sign the .so file inside
          find "${{ env.LV2_PATH }}" -name "*.so" -exec codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v {} --strict --options=runtime --timestamp \;

          # Verify signature
          find "${{ env.LV2_PATH }}" -name "*.so" -exec codesign --verify --strict --verbose=2 {} \;

      - name: Add Custom Icons
        run: |
          # Add the icns as its own icon resource
          sips -i packaging/resources/icon.icns

          # Extract the resource to a temp file
          DeRez -only icns packaging/resources/icon.icns > /tmp/icons

          # Add the icon resource to each plugin
          Rez -a /tmp/icons -o "${{ env.VST3_PATH }}/Icon"$'\r'
          Rez -a /tmp/icons -o "${{ env.AU_PATH }}/Icon"$'\r'

          # Set the custom icon attribute
          SetFile -a C "${{ env.VST3_PATH }}"
          SetFile -a C "${{ env.AU_PATH }}"

      - name: Create Packages and Notarize
        timeout-minutes: 15
        run: |
          # Create packaging directory
          mkdir -p packaging

          # Create individual PKG files for each plugin format
          pkgbuild --identifier "${{ env.BUNDLE_ID }}.au.pkg" \
            --version ${{ env.VERSION }} \
            --component "${{ env.AU_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/Components" \
            "packaging/${{ env.PRODUCT_NAME }}.au.pkg"

          pkgbuild --identifier "${{ env.BUNDLE_ID }}.vst3.pkg" \
            --version ${{ env.VERSION }} \
            --component "${{ env.VST3_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/VST3" \
            "packaging/${{ env.PRODUCT_NAME }}.vst3.pkg"

          # Standalone needs special handling to install in /Applications
          pkgbuild --analyze --root "$(dirname "${{ env.STANDALONE_PATH }}")" standalone.plist
          plutil -replace BundleIsRelocatable -bool NO standalone.plist
          pkgbuild --identifier "${{ env.BUNDLE_ID }}.app.pkg" \
            --version ${{ env.VERSION }} \
            --root "$(dirname "${{ env.STANDALONE_PATH }}")" \
            --component-plist standalone.plist \
            --install-location "/Applications" \
            "packaging/${{ env.PRODUCT_NAME }}.app.pkg"

          pkgbuild --identifier "${{ env.BUNDLE_ID }}.clap.pkg" \
            --version ${{ env.VERSION }} \
            --component "${{ env.CLAP_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/CLAP" \
            "packaging/${{ env.PRODUCT_NAME }}.clap.pkg"

          pkgbuild --identifier "${{ env.BUNDLE_ID }}.lv2.pkg" \
            --version ${{ env.VERSION }} \
            --root "${{ env.LV2_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/LV2" \
            "packaging/${{ env.PRODUCT_NAME }}.lv2.pkg"

          # Process distribution.xml to replace variables
          cd packaging
          envsubst < macos/distribution.xml > distribution.xml

          # Create the final signed PKG with productbuild
          productbuild --distribution distribution.xml \
            --resources ./resources \
            --sign "${{ secrets.DEVELOPER_ID_INSTALLER }}" \
            --timestamp \
            "${{ env.ARTIFACT_NAME }}.pkg"

          # Notarize the PKG
          xcrun notarytool submit "${{ env.ARTIFACT_NAME }}.pkg" \
            --apple-id "${{ secrets.NOTARIZATION_USERNAME }}" \
            --password "${{ secrets.NOTARIZATION_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "${{ env.ARTIFACT_NAME }}.pkg"

          # Verify the staple worked
          xcrun stapler validate "${{ env.ARTIFACT_NAME }}.pkg"

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: packaging/${{ env.ARTIFACT_NAME }}.pkg
