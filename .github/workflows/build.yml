name: SpectralShift

on:
  workflow_dispatch: # run manually from GitHub UI
  push:
    branches: [ main ]
  pull_request:

# Cancel in-progress builds when new commits pushed
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  BUILD_DIR: Builds
  DISPLAY: :0 # Linux pluginval needs this
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  SCCACHE_GHA_ENABLED: true

defaults:
  run:
    shell: bash

jobs:
  build_and_test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-22.04
            pluginval-binary: ./pluginval
            extra-flags: -G Ninja
          - name: macOS
            os: macos-14
            pluginval-binary: pluginval.app/Contents/MacOS/pluginval
            extra-flags: -G Ninja -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"

    steps:
      - name: Set up Clang
        if: runner.os == 'Linux'
        uses: egor-tensin/setup-clang@v1

      - name: Install JUCE's Linux Deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update && sudo apt install libasound2-dev libx11-dev libxinerama-dev libxext-dev libfreetype6-dev libwebkit2gtk-4.0-dev libglu1-mesa-dev xvfb ninja-build
          sudo /usr/bin/Xvfb $DISPLAY &

      - name: Install macOS Deps
        if: ${{ matrix.name == 'macOS' }}
        run: brew install ninja osxutils

      - name: Use latest Xcode
        if: ${{ matrix.name == 'macOS' }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache the build (sccache)
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure
        run: cmake -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache ${{ matrix.extra-flags }}

      - name: Build
        run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

      - name: Read in .env from CMake
        run: |
          cat ${{ env.BUILD_DIR }}/.env
          cat ${{ env.BUILD_DIR }}/.env >> $GITHUB_ENV

      - name: Set additional env vars for artifacts
        run: |
          ARTIFACTS_PATH="${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}_artefacts/${{ env.BUILD_TYPE }}"
          echo "ARTIFACTS_PATH=$ARTIFACTS_PATH" >> $GITHUB_ENV
          echo "VST3_PATH=$ARTIFACTS_PATH/VST3/${{ env.PRODUCT_NAME }}.vst3" >> $GITHUB_ENV
          echo "AU_PATH=$ARTIFACTS_PATH/AU/${{ env.PRODUCT_NAME }}.component" >> $GITHUB_ENV
          echo "CLAP_PATH=$ARTIFACTS_PATH/CLAP/${{ env.PRODUCT_NAME }}.clap" >> $GITHUB_ENV
          echo "STANDALONE_PATH=$ARTIFACTS_PATH/Standalone/${{ env.PRODUCT_NAME }}.app" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${{ env.PRODUCT_NAME }}-${{ env.VERSION }}-${{ matrix.name }}" >> $GITHUB_ENV

      - name: Pluginval (before signing)
        run: |
          curl -LO "https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_${{ matrix.name }}.zip"
          7z x pluginval_${{ matrix.name }}.zip
          ${{ matrix.pluginval-binary }} --strictness-level 10 --verbose \
            --validate "${{ env.VST3_PATH }}"

      - name: Import Developer ID Certificates
        if: ${{ matrix.name == 'macOS' }}
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.DEV_ID_CERT }}
          p12-password: ${{ secrets.DEV_ID_CERT_PASSWORD }}

      - name: Code Sign VST3
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.VST3_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.VST3_PATH }}"

      - name: Code Sign AU
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.AU_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.AU_PATH }}"

      - name: Code Sign Standalone
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.STANDALONE_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.STANDALONE_PATH }}"

      - name: Code Sign CLAP
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.CLAP_PATH }}" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "${{ env.CLAP_PATH }}"

      - name: Add Custom Icons
        if: ${{ matrix.name == 'macOS' }}
        run: |
          # Add the icns as its own icon resource
          sips -i packaging/icon.icns

          # Extract the resource to a temp file
          DeRez -only icns packaging/icon.icns > /tmp/icons

          # Add the icon resource to each plugin
          Rez -a /tmp/icons -o "${{ env.VST3_PATH }}/Icon"$'\r'
          Rez -a /tmp/icons -o "${{ env.AU_PATH }}/Icon"$'\r'

          # Set the custom icon attribute
          SetFile -a C "${{ env.VST3_PATH }}"
          SetFile -a C "${{ env.AU_PATH }}"

      - name: Create Packages and Notarize
        if: ${{ matrix.name == 'macOS' }}
        timeout-minutes: 15
        run: |
          # Create packaging directory
          mkdir -p packaging

          # Create individual PKG files for each plugin format
          pkgbuild --identifier "${{ env.BUNDLE_ID }}.au.pkg" \
            --version ${{ env.VERSION }} \
            --component "${{ env.AU_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/Components" \
            "packaging/${{ env.PRODUCT_NAME }}.au.pkg"

          pkgbuild --identifier "${{ env.BUNDLE_ID }}.vst3.pkg" \
            --version ${{ env.VERSION }} \
            --component "${{ env.VST3_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/VST3" \
            "packaging/${{ env.PRODUCT_NAME }}.vst3.pkg"

          # Standalone needs special handling to install in /Applications
          pkgbuild --analyze --root "$(dirname "${{ env.STANDALONE_PATH }}")" standalone.plist
          plutil -replace BundleIsRelocatable -bool NO standalone.plist
          pkgbuild --identifier "${{ env.BUNDLE_ID }}.app.pkg" \
            --version ${{ env.VERSION }} \
            --root "$(dirname "${{ env.STANDALONE_PATH }}")" \
            --component-plist standalone.plist \
            --install-location "/Applications" \
            "packaging/${{ env.PRODUCT_NAME }}.app.pkg"

          pkgbuild --identifier "${{ env.BUNDLE_ID }}.clap.pkg" \
            --version ${{ env.VERSION }} \
            --component "${{ env.CLAP_PATH }}" \
            --install-location "/Library/Audio/Plug-Ins/CLAP" \
            "packaging/${{ env.PRODUCT_NAME }}.clap.pkg"

          # Create distribution.xml for productbuild
          cat > packaging/distribution.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
              <title>${{ env.PRODUCT_NAME }} ${{ env.VERSION }}</title>
              <organization>${{ env.BUNDLE_ID }}</organization>
              <domains enable_localSystem="true"/>
              <options customize="always" require-scripts="false" hostArchitectures="arm64,x86_64"/>
              <welcome file="welcome.html" mime-type="text/html"/>
              <license file="license.html" mime-type="text/html"/>
              <conclusion file="conclusion.html" mime-type="text/html"/>

              <pkg-ref id="${{ env.BUNDLE_ID }}.au.pkg" version="${{ env.VERSION }}" onConclusion="none">${{ env.PRODUCT_NAME }}.au.pkg</pkg-ref>
              <pkg-ref id="${{ env.BUNDLE_ID }}.vst3.pkg" version="${{ env.VERSION }}" onConclusion="none">${{ env.PRODUCT_NAME }}.vst3.pkg</pkg-ref>
              <pkg-ref id="${{ env.BUNDLE_ID }}.app.pkg" version="${{ env.VERSION }}" onConclusion="none">${{ env.PRODUCT_NAME }}.app.pkg</pkg-ref>
              <pkg-ref id="${{ env.BUNDLE_ID }}.clap.pkg" version="${{ env.VERSION }}" onConclusion="none">${{ env.PRODUCT_NAME }}.clap.pkg</pkg-ref>

              <choices-outline>
                  <line choice="${{ env.BUNDLE_ID }}.au.pkg"/>
                  <line choice="${{ env.BUNDLE_ID }}.vst3.pkg"/>
                  <line choice="${{ env.BUNDLE_ID }}.app.pkg"/>
                  <line choice="${{ env.BUNDLE_ID }}.clap.pkg"/>
              </choices-outline>

              <choice id="${{ env.BUNDLE_ID }}.au.pkg" visible="true" title="Audio Unit (AU)" description="Install the AU plugin">
                  <pkg-ref id="${{ env.BUNDLE_ID }}.au.pkg"/>
              </choice>
              <choice id="${{ env.BUNDLE_ID }}.vst3.pkg" visible="true" title="VST3" description="Install the VST3 plugin">
                  <pkg-ref id="${{ env.BUNDLE_ID }}.vst3.pkg"/>
              </choice>
              <choice id="${{ env.BUNDLE_ID }}.app.pkg" visible="true" title="Standalone App" description="Install the standalone application">
                  <pkg-ref id="${{ env.BUNDLE_ID }}.app.pkg"/>
              </choice>
              <choice id="${{ env.BUNDLE_ID }}.clap.pkg" visible="true" title="CLAP" description="Install the CLAP plugin">
                  <pkg-ref id="${{ env.BUNDLE_ID }}.clap.pkg"/>
              </choice>
          </installer-gui-script>
          EOF

          # Create the final signed PKG with productbuild
          cd packaging
          productbuild --distribution distribution.xml \
            --resources ./resources \
            --sign "${{ secrets.DEVELOPER_ID_INSTALLER }}" \
            --timestamp \
            "${{ env.ARTIFACT_NAME }}.pkg"

          # Notarize the PKG
          xcrun notarytool submit "${{ env.ARTIFACT_NAME }}.pkg" \
            --apple-id "${{ secrets.NOTARIZATION_USERNAME }}" \
            --password "${{ secrets.NOTARIZATION_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "${{ env.ARTIFACT_NAME }}.pkg"

          # Verify the staple worked
          xcrun stapler validate "${{ env.ARTIFACT_NAME }}.pkg"

      - name: Zip (Linux)
        if: ${{ matrix.name == 'Linux' }}
        run: |
          # Copy packaging/linux contents to artifacts directory
          cp -r packaging/linux/* ${{ env.ARTIFACTS_PATH }}/
          cp packaging/icon.png ${{ env.ARTIFACTS_PATH }}/

          # Create zip with build artifacts and packaging files, excluding the SharedCode library
          cd ${{ env.ARTIFACTS_PATH }}
          7z a -tzip "${{ env.ARTIFACT_NAME }}.zip" "-xr!lib${{ env.PRODUCT_NAME }}_SharedCode.a" .

      - name: Upload package (macOS)
        if: ${{ matrix.name == 'macOS' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: packaging/${{ env.ARTIFACT_NAME }}.pkg

      - name: Upload zip (Linux)
        if: ${{ matrix.name == 'Linux' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACTS_PATH }}/${{ env.ARTIFACT_NAME }}.zip
