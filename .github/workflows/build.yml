name: SpectralShift

on:
  workflow_dispatch: # run manually from GitHub UI
  push:
    branches: [ main ]
  pull_request:

# Cancel in-progress builds when new commits pushed
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  BUILD_DIR: Builds
  DISPLAY: :0 # Linux pluginval needs this
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  SCCACHE_GHA_ENABLED: true

defaults:
  run:
    shell: bash

jobs:
  build_and_test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-22.04
            pluginval-binary: ./pluginval
            extra-flags: -G Ninja
          - name: macOS
            os: macos-14
            pluginval-binary: pluginval.app/Contents/MacOS/pluginval
            extra-flags: -G Ninja -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"

    steps:
      - name: Set up Clang
        if: runner.os == 'Linux'
        uses: egor-tensin/setup-clang@v1

      - name: Install JUCE's Linux Deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update && sudo apt install libasound2-dev libx11-dev libxinerama-dev libxext-dev libfreetype6-dev libwebkit2gtk-4.0-dev libglu1-mesa-dev xvfb ninja-build
          sudo /usr/bin/Xvfb $DISPLAY &

      - name: Install macOS Deps
        if: ${{ matrix.name == 'macOS' }}
        run: brew install ninja osxutils

      - name: Use latest Xcode
        if: ${{ matrix.name == 'macOS' }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache the build (sccache)
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure
        run: cmake -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache ${{ matrix.extra-flags }}

      - name: Build
        run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

      - name: Pluginval (before signing)
        run: |
          curl -LO "https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_${{ matrix.name }}.zip"
          7z x pluginval_${{ matrix.name }}.zip
          ${{ matrix.pluginval-binary }} --strictness-level 10 --verbose \
            --validate "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/VST3/SpectralShift.vst3"

      - name: Import Developer ID Certificates
        if: ${{ matrix.name == 'macOS' }}
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.DEV_ID_CERT }}
          p12-password: ${{ secrets.DEV_ID_CERT_PASSWORD }}

      - name: Code Sign VST3
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/VST3/SpectralShift.vst3" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 \
            "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/VST3/SpectralShift.vst3"

      - name: Code Sign AU
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/AU/SpectralShift.component" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 \
            "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/AU/SpectralShift.component"

      - name: Code Sign Standalone
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/Standalone/SpectralShift.app" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 \
            "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/Standalone/SpectralShift.app"

      - name: Code Sign CLAP
        if: ${{ matrix.name == 'macOS' }}
        run: |
          codesign --force -s "${{ secrets.DEVELOPER_ID_APPLICATION}}" -v "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/CLAP/SpectralShift.clap" --deep --strict --options=runtime --timestamp

          # Verify signature
          codesign --verify --deep --strict --verbose=2 \
            "${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/CLAP/SpectralShift.clap"

      - name: Add Custom Icons (optional)
        if: ${{ matrix.name == 'macOS' && false }}
        run: |
          ARTIFACTS_PATH="${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}"

          # Add the icns as its own icon resource
          sips -i packaging/icon.icns

          # Extract the resource to a temp file
          DeRez -only icns packaging/icon.icns > /tmp/icons

          # Add the icon resource to each plugin
          Rez -a /tmp/icons -o "$ARTIFACTS_PATH/VST3/SpectralShift.vst3/Icon"$'\r'
          Rez -a /tmp/icons -o "$ARTIFACTS_PATH/AU/SpectralShift.component/Icon"$'\r'

          # Set the custom icon attribute
          SetFile -a C "$ARTIFACTS_PATH/VST3/SpectralShift.vst3"
          SetFile -a C "$ARTIFACTS_PATH/AU/SpectralShift.component"

      - name: Create Packages and Notarize
        if: ${{ matrix.name == 'macOS' }}
        timeout-minutes: 15
        run: |
          # Set variables
          ARTIFACTS_PATH="${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}"
          VERSION="1.0.0"
          BUNDLE_ID="com.trencrumb.spectralshift"
          PRODUCT_NAME="SpectralShift"

          # Create packaging directory
          mkdir -p packaging

          # Create individual PKG files for each plugin format
          pkgbuild --identifier "${BUNDLE_ID}.au.pkg" \
            --version ${VERSION} \
            --component "${ARTIFACTS_PATH}/AU/SpectralShift.component" \
            --install-location "/Library/Audio/Plug-Ins/Components" \
            "packaging/${PRODUCT_NAME}.au.pkg"

          pkgbuild --identifier "${BUNDLE_ID}.vst3.pkg" \
            --version ${VERSION} \
            --component "${ARTIFACTS_PATH}/VST3/SpectralShift.vst3" \
            --install-location "/Library/Audio/Plug-Ins/VST3" \
            "packaging/${PRODUCT_NAME}.vst3.pkg"

          # Standalone needs special handling to install in /Applications
          pkgbuild --analyze --root "$(dirname "${ARTIFACTS_PATH}/Standalone/SpectralShift.app")" standalone.plist
          plutil -replace BundleIsRelocatable -bool NO standalone.plist
          pkgbuild --identifier "${BUNDLE_ID}.app.pkg" \
            --version ${VERSION} \
            --root "$(dirname "${ARTIFACTS_PATH}/Standalone/SpectralShift.app")" \
            --component-plist standalone.plist \
            --install-location "/Applications" \
            "packaging/${PRODUCT_NAME}.app.pkg"

          pkgbuild --identifier "${BUNDLE_ID}.clap.pkg" \
            --version ${VERSION} \
            --component "${ARTIFACTS_PATH}/CLAP/SpectralShift.clap" \
            --install-location "/Library/Audio/Plug-Ins/CLAP" \
            "packaging/${PRODUCT_NAME}.clap.pkg"

          # Create distribution.xml for productbuild
          cat > packaging/distribution.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
              <title>SpectralShift</title>
              <organization>com.trencrumb.spectralshift</organization>
              <domains enable_localSystem="true"/>
              <options customize="always" require-scripts="false" hostArchitectures="arm64,x86_64"/>

              <pkg-ref id="com.trencrumb.spectralshift.au.pkg" version="1.0.0" onConclusion="none">SpectralShift.au.pkg</pkg-ref>
              <pkg-ref id="com.trencrumb.spectralshift.vst3.pkg" version="1.0.0" onConclusion="none">SpectralShift.vst3.pkg</pkg-ref>
              <pkg-ref id="com.trencrumb.spectralshift.app.pkg" version="1.0.0" onConclusion="none">SpectralShift.app.pkg</pkg-ref>
              <pkg-ref id="com.trencrumb.spectralshift.clap.pkg" version="1.0.0" onConclusion="none">SpectralShift.clap.pkg</pkg-ref>

              <choices-outline>
                  <line choice="com.trencrumb.spectralshift.au.pkg"/>
                  <line choice="com.trencrumb.spectralshift.vst3.pkg"/>
                  <line choice="com.trencrumb.spectralshift.app.pkg"/>
                  <line choice="com.trencrumb.spectralshift.clap.pkg"/>
              </choices-outline>

              <choice id="com.trencrumb.spectralshift.au.pkg" visible="true" title="Audio Unit (AU)" description="Install the AU plugin">
                  <pkg-ref id="com.trencrumb.spectralshift.au.pkg"/>
              </choice>
              <choice id="com.trencrumb.spectralshift.vst3.pkg" visible="true" title="VST3" description="Install the VST3 plugin">
                  <pkg-ref id="com.trencrumb.spectralshift.vst3.pkg"/>
              </choice>
              <choice id="com.trencrumb.spectralshift.app.pkg" visible="true" title="Standalone App" description="Install the standalone application">
                  <pkg-ref id="com.trencrumb.spectralshift.app.pkg"/>
              </choice>
              <choice id="com.trencrumb.spectralshift.clap.pkg" visible="true" title="CLAP" description="Install the CLAP plugin">
                  <pkg-ref id="com.trencrumb.spectralshift.clap.pkg"/>
              </choice>
          </installer-gui-script>
          EOF

          # Create the final signed PKG with productbuild
          cd packaging
          productbuild --distribution distribution.xml \
            --resources ./resources \
            --sign "${{ secrets.DEVELOPER_ID_INSTALLER }}" \
            --timestamp \
            "SpectralShift-macOS.pkg"

          # Notarize the PKG
          xcrun notarytool submit "SpectralShift-macOS.pkg" \
            --apple-id "${{ secrets.NOTARIZATION_USERNAME }}" \
            --password "${{ secrets.NOTARIZATION_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "SpectralShift-macOS.pkg"

          # Verify the staple worked
          xcrun stapler validate "SpectralShift-macOS.pkg"

      - name: Zip (Linux)
        if: ${{ matrix.name == 'Linux' }}
        working-directory: ${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}
        run: 7z a -tzip "SpectralShift-Linux.zip" .

      - name: Upload package (macOS)
        if: ${{ matrix.name == 'macOS' }}
        uses: actions/upload-artifact@v4
        with:
          name: SpectralShift-macOS-${{ github.sha }}
          path: packaging/SpectralShift-macOS.pkg

      - name: Upload zip (Linux)
        if: ${{ matrix.name == 'Linux' }}
        uses: actions/upload-artifact@v4
        with:
          name: SpectralShift-Linux-${{ github.sha }}
          path: ${{ env.BUILD_DIR }}/SpectralShift_artefacts/${{ env.BUILD_TYPE }}/SpectralShift-Linux.zip
